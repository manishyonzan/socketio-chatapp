<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO chat</title>
    <style>
        body {
            margin: 0;
            padding-bottom: 3rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .container {
            display: flex;
            justify-content: center;
            border: .5px solid rgb(214, 208, 208);
            height: 85vh;
        }

        .container-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: start;
            overflow-y: scroll;

            h3 {
                padding: 0;
                margin: 0;
                text-align: center;
            }
        }

        .container-left .conversation {
            border: 0.5px solid #e9e1e1;
            color: #333;
            padding: 5px 0px;
            cursor: pointer;


            h4 {
                margin: 0;
                padding: 0;
            }

            h5 {
                margin: 0;
                padding: 0;
            }
        }

        .container-left--people {
            border: 0.5px solid #e9e1e1;
            color: #333;
            padding: 5px 0px;
            cursor: pointer;


            h4 {
                margin: 0;
                padding: 0;
            }

            h5 {
                margin: 0;
                padding: 0;
            }
        }

        .container-right {
            flex: 4;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            background-color: #e9e1e1;
        }

        #form {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            display: flex;
            height: 3rem;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        #input {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        #input:focus {
            outline: none;
        }

        #form>button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;

        }

        #messages>li {
            padding: 0.5rem 1rem;
        }

        #messages>li:nth-child(odd) {
            background: #efefef;
        }
    </style>
</head>

<body>
    <h2 id="roomid"></h2>
    <input type="text" id="roomInput" placeholder="Enter Room ID to send" />
    <div class="container">
        <div class="container-left">
            <h3>Messages</h3>
            <div id="conversation-div">
                <div class="conversation">
                    <h4>conversation name</h3>
                        <h5>last message</h5>
                </div>
            </div>

            <h3>all people</h3>

            <div id="unconnected-div">
                <div class="container-left--people">
                    <h4>conversation name</h3>
                        <h5>last message</h5>
                </div>
            </div>

        </div>
        <div class="container-right">
            <ul id="messages"></ul>
            <form id="form" action="">
                <input id="input" autocomplete="off" /><button id="sendBtn">Send</button>
            </form>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            auth: {
                token: `Bearer ${localStorage.getItem('chatapp-token')}`
            }
        });

        let messagesGlobal = []
        let userListGlobal = []

        const setScreen = () => {

            messagesGlobal.forEach((msg, index) => {

                const item = document.createElement('li');
                const chatwindow = document.getElementById('messages');
                // { message: msg.msg, senderId: socket.user.id, content: msg.msg } this is the msg object
                item.textContent = msg.content;
                document.getElementById('messages').appendChild(item);
            })
        }

        setScreen();

        let roomIdGlobal = null;

        socket.on("connect", () => {
            document.getElementById('roomid').innerText = "Room ID: " + socket.id;
        })

        socket.on('chat-message', function (msg) {
            const item = document.createElement('li');
            const chatwindow = document.getElementById('messages');
            // { message: msg.msg, senderId: socket.user.id, content: msg.msg } this is the msg object
            item.textContent = msg.message;
            document.getElementById('messages').appendChild(item);
            chatwindow.scrollTo(0, document.body.scrollHeight);
        });

        function joinRoom(roomId) {
            if (!roomId) return null;
            console.log("joining room:", roomId);
            socket.emit("join-room", roomId);
        }

        joinRoom(roomIdGlobal);


        socket.on("connect_error", (err) => {
            console.error("Connection error:", err.message); // e.g., "Invalid token"
            // Optional: show UI feedback or retry logic
        });

        const sendBtn = document.getElementById('sendBtn');
        const input = document.getElementById('input');
        sendBtn.addEventListener("click", (e) => {
            e.preventDefault();

            if (!roomIdGlobal) return null;
            let roomId = roomIdGlobal;

            // for now 
            if (input.value && roomId) {
                socket.emit('chat-message', { msg: input.value, roomId: roomId });
                input.value = '';
            }
        });

        // get messages and create rooms

        const getRooms = (firstUserId, secondUserId) => {
            fetch('/api/v1/connection/conversations', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('chatapp-token')}`
                }
            })
                .then(async response => {
                    return response.json();
                })
                .then(data => {
                    data.data.forEach(element => {
                        const item = document.createElement("div");
                        item.className = "conversation";
                        item.setAttribute("data-roomid", element.name);
                        const header = document.createElement("h4")
                        header.textContent = element.name;
                        item.appendChild(header);
                        const message = document.createElement("h5")
                        message.textContent = element.type;
                        item.appendChild(message);

                        item.addEventListener("click", () => {
                            const id = item.getAttribute("data-roomid");
                            roomIdGlobal = item.getAttribute("data-roomid");

                            joinRoom(id)

                            const newItem = document.createElement("ul");
                            newItem.id = "messages";
                            document.getElementById('messages').replaceWith(newItem);

                            fetch(`/api/v1/connection/messages/${element.name}`, {
                                method: 'GET',
                                credentials: 'same-origin',
                                headers: {
                                    Authorization: `Bearer ${localStorage.getItem('chatapp-token')}`
                                }
                            })
                                .then(res => res.json())
                                .then(msg => {
                                    messagesGlobal = msg.data;

                                    msg.data.forEach((eachMessage, index) => {
                                        const item = document.createElement('li');
                                        const chatwindow = document.getElementById('messages');
                                        // { message: msg.msg, senderId: socket.user.id, content: msg.msg } this is the msg object
                                        item.textContent = eachMessage.content;
                                        document.getElementById('messages').appendChild(item);
                                        chatwindow.scrollTo(0, document.body.scrollHeight);
                                    })
                                    // handle response
                                })
                                .catch(err => {
                                    console.error("Fetch error:", err);
                                });
                        });



                        const conversationListDiv = document.getElementById("conversation-div");
                        conversationListDiv.appendChild(item);
                    });

                    console.log("Conversation data:", data);
                })
                .catch(error => {
                    console.error('Error creating/getting conversation:', error);
                });
        };

        getRooms();



        // get all users
        const getAllUser = async () => {

            const user = await fetch('/api/v1/authentication/user/allusers', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('chatapp-token')}`
                }

            })
            const data = await user.json()
            userListGlobal = [...data.data]
            console.log(userListGlobal, "all data")



            // creting the userlist ui
            createUserUi(userListGlobal);

        }

        getAllUser();


        const createUserUi = (users) => {
            users.forEach(element => {
                const item = document.createElement("div");
                item.className = "container-left--people";
                item.setAttribute("data-userid", element._id);
                const header = document.createElement("h4")
                header.textContent = element.name;
                item.appendChild(header);
                const message = document.createElement("h5")
                message.textContent = "click to message";
                item.appendChild(message);

                item.addEventListener("click", () => {


                    fetch(`/api/v1/connection/conversations`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        body: JSON.stringify({ type: "private", participants: [item.getAttribute("data-userid")] }),
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem('chatapp-token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                        .then(res => res.json())
                        .then(data => {
                            console.log("on user click", data)
                            userListGlobal = [...userListGlobal, data.data];


                            const item = document.createElement("div");
                            item.className = "conversation";
                            item.setAttribute("data-roomid", data.data.name);
                            const header = document.createElement("h4")
                            header.textContent = data.data.name;
                            item.appendChild(header);
                            const message = document.createElement("h5")
                            message.textContent = data.data.type;
                            item.appendChild(message);

                            item.addEventListener("click", () => {
                                const id = item.getAttribute("data-roomid");
                                roomIdGlobal = item.getAttribute("data-roomid");

                                fetch(`/api/v1/connection/messages/${element.name}`, {
                                    method: 'GET',
                                    credentials: 'same-origin',
                                    headers: {
                                        Authorization: `Bearer ${localStorage.getItem('chatapp-token')}`
                                    }
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        messagesGlobal = data.data;
                                        // handle response
                                    })
                                    .catch(err => {
                                        console.error("Fetch error:", err);
                                    });
                            });



                            const conversationListDiv = document.getElementById("conversation-div");
                            conversationListDiv.appendChild(item);
                            // handle response
                        })
                        .catch(err => {
                            alert("room was already created with  this user");
                            console.error("Fetch error:", err);
                        });
                });



                const userListDiv = document.getElementById("unconnected-div");
                userListDiv.appendChild(item);
            })
        };




        // create rooms



    </script>

    <script>
        // check whether user is logged in
        const token = localStorage.getItem('chatapp-token');
        if (!token) {
            // redirect to login page
            window.location.href = '/index.html';
        }  
    </script>

</body>

</html>